<%- include('partials/header', { title, user }) %>

<section class="zikr-page">
  <% if (success) { %>
  <p class="message success"><%= success %></p>
  <% } %>
  <% if (error) { %>
  <p class="message error"><%= error %></p>
  <% } %>

  <% if (!userZikirs.length) { %>
  <article class="zikr-shell empty-shell">
    <h1>Zikir listesi bos</h1>
    <p>Asagidaki formdan zikir ekleyerek baslayabilirsiniz.</p>
  </article>
  <% } else { %>
  <article class="zikr-shell" id="zikrShell">
    <div class="top-controls">
      <button id="themeToggle" class="icon-button" type="button" aria-label="Tema degistir">‚òÄÔ∏è</button>

      <div class="step-nav-wrap">
        <button id="prevStep" class="arrow-btn" type="button" aria-label="Onceki">‚Äπ</button>
        <div id="stepNav" class="step-nav"></div>
        <button id="nextStep" class="arrow-btn" type="button" aria-label="Sonraki">‚Ä∫</button>
      </div>

      <button id="resetCurrent" class="icon-button danger" type="button" aria-label="Sayaci sifirla">‚Ü∫</button>
    </div>

    <div id="mainScreen" class="main-screen">
      <div class="headline">
        <div id="stepInfo" class="step-info"></div>
        <h2 id="titleText" class="title-text"></h2>
      </div>

      <div class="prayer-area" id="prayerArea">
        <p id="prayerText" class="prayer-text"></p>
      </div>

      <div class="action-footer">
        <div class="counter-row">
          <div class="counter-ring-wrap">
            <svg class="counter-ring" viewBox="0 0 110 110" aria-hidden="true">
              <circle cx="55" cy="55" r="47" class="ring-bg"></circle>
              <circle id="ringProgress" cx="55" cy="55" r="47" class="ring-progress"></circle>
            </svg>
            <div id="countText" class="count-text">0</div>
          </div>
          <div class="target-box">
            <span>HEDEF</span>
            <strong id="targetText">0</strong>
          </div>
        </div>

        <button id="mainBtn" class="main-btn" type="button">OKUDUM</button>

        <div class="mini-actions">
          <button id="minusBtn" type="button" class="mini-btn">-1</button>
          <form id="deleteForm" method="post">
            <button type="submit" class="mini-btn danger">Sil</button>
          </form>
        </div>
      </div>
    </div>

    <div id="finishScreen" class="finish-screen hidden">
      <div class="finish-icon">ü§≤</div>
      <h3>Zikrilerinizi tamamladiniz.</h3>
      <p>Allah kabul etsin.</p>
    </div>
  </article>

  <script id="zikrData" type="application/json"><%- JSON.stringify(userZikirs) %></script>
  <script>
    (() => {
      const raw = document.getElementById('zikrData');
      if (!raw) return;

      const zikirs = JSON.parse(raw.textContent || '[]');
      if (!zikirs.length) return;

      const $ = (id) => document.getElementById(id);

      const stepNav = $('stepNav');
      const stepInfo = $('stepInfo');
      const titleText = $('titleText');
      const prayerText = $('prayerText');
      const countText = $('countText');
      const targetText = $('targetText');
      const ringProgress = $('ringProgress');
      const mainBtn = $('mainBtn');
      const minusBtn = $('minusBtn');
      const resetCurrent = $('resetCurrent');
      const prevStep = $('prevStep');
      const nextStep = $('nextStep');
      const themeToggle = $('themeToggle');
      const deleteForm = $('deleteForm');
      const mainScreen = $('mainScreen');
      const finishScreen = $('finishScreen');

      const THEME_KEY = 'zikirmatik-theme';
      const CIRCUMFERENCE = 2 * Math.PI * 47;

      const savedTheme = localStorage.getItem(THEME_KEY);
      const initialTheme = savedTheme === 'light' || savedTheme === 'dark' ? savedTheme : 'dark';
      document.documentElement.setAttribute('data-theme', initialTheme);

      let activeIndex = 0;
      let busy = false;

      const isCompleted = (item) => item.current_count >= item.target_count;
      const allCompleted = () => zikirs.length > 0 && zikirs.every((item) => isCompleted(item));

      function firstIncompleteIndex() {
        const idx = zikirs.findIndex((item) => !isCompleted(item));
        return idx === -1 ? 0 : idx;
      }

      function nextIncompleteIndex(from) {
        for (let i = from + 1; i < zikirs.length; i += 1) {
          if (!isCompleted(zikirs[i])) return i;
        }
        for (let i = 0; i <= from; i += 1) {
          if (!isCompleted(zikirs[i])) return i;
        }
        return -1;
      }

      function syncThemeIcon() {
        const t = document.documentElement.getAttribute('data-theme') || 'dark';
        themeToggle.textContent = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      }

      function setBusyState(state) {
        busy = state;
        mainBtn.disabled = state || allCompleted();
        minusBtn.disabled = state || allCompleted();
        resetCurrent.disabled = state || allCompleted();
      }

      function renderDots() {
        stepNav.innerHTML = '';
        zikirs.forEach((item, index) => {
          const dot = document.createElement('button');
          dot.type = 'button';
          dot.className = 'step-dot';
          if (index === activeIndex) dot.classList.add('active');
          if (isCompleted(item)) dot.classList.add('done');
          dot.addEventListener('click', () => {
            activeIndex = index;
            render();
          });
          stepNav.appendChild(dot);
        });

        const activeDot = stepNav.children[activeIndex];
        if (activeDot) {
          activeDot.scrollIntoView({ block: 'nearest', inline: 'center', behavior: 'smooth' });
        }
      }

      function render() {
        if (!zikirs.length) return;

        if (allCompleted()) {
          mainScreen.classList.add('hidden');
          finishScreen.classList.remove('hidden');
          renderDots();
          prevStep.disabled = true;
          nextStep.disabled = true;
          setBusyState(false);
          return;
        }

        mainScreen.classList.remove('hidden');
        finishScreen.classList.add('hidden');

        if (!zikirs[activeIndex] || isCompleted(zikirs[activeIndex])) {
          activeIndex = firstIncompleteIndex();
        }

        const item = zikirs[activeIndex];
        if (!item) return;

        stepInfo.textContent = `ASAMA ${activeIndex + 1} / ${zikirs.length}`;
        titleText.textContent = item.title;
        prayerText.textContent = item.description || item.title;
        countText.textContent = String(item.current_count);
        targetText.textContent = String(item.target_count);

        const progress = item.target_count > 0
          ? Math.min(1, item.current_count / item.target_count)
          : 0;

        ringProgress.style.strokeDasharray = String(CIRCUMFERENCE);
        ringProgress.style.strokeDashoffset = String(CIRCUMFERENCE - (CIRCUMFERENCE * progress));
        mainBtn.textContent = isCompleted(item) ? 'TAMAMLANDI' : 'OKUDUM';

        deleteForm.action = `/zikirs/${item.id}/delete`;

        prevStep.disabled = activeIndex === 0;
        nextStep.disabled = activeIndex === zikirs.length - 1;

        renderDots();
        setBusyState(false);
      }

      async function postCounter(action) {
        if (busy || !zikirs[activeIndex]) return;

        setBusyState(true);
        const item = zikirs[activeIndex];

        try {
          const response = await fetch(`/zikirs/${item.id}/${action}?ajax=1`, {
            method: 'POST',
            headers: { Accept: 'application/json' },
            credentials: 'same-origin',
          });

          const contentType = response.headers.get('content-type') || '';
          if (!response.ok || !contentType.includes('application/json')) {
            window.location.reload();
            return;
          }

          const payload = await response.json();
          item.current_count = payload.currentCount;
          item.target_count = payload.targetCount;

          if (action === 'increment' && isCompleted(item)) {
            const ni = nextIncompleteIndex(activeIndex);
            if (ni !== -1) activeIndex = ni;
          }

          render();
        } catch (err) {
          console.error(err);
          alert('Islem sirasinda hata olustu.');
          setBusyState(false);
        }
      }

      mainBtn.addEventListener('click', () => postCounter('increment'));
      minusBtn.addEventListener('click', () => postCounter('decrement'));
      resetCurrent.addEventListener('click', () => postCounter('reset'));

      prevStep.addEventListener('click', () => {
        if (activeIndex > 0) {
          activeIndex -= 1;
          render();
        }
      });

      nextStep.addEventListener('click', () => {
        if (activeIndex < zikirs.length - 1) {
          activeIndex += 1;
          render();
        }
      });

      deleteForm.addEventListener('submit', (event) => {
        const item = zikirs[activeIndex];
        if (!item) {
          event.preventDefault();
          return;
        }

        if (!confirm(`"${item.title}" silinsin mi?`)) {
          event.preventDefault();
        }
      });

      themeToggle.addEventListener('click', () => {
        const curr = document.documentElement.getAttribute('data-theme') || 'dark';
        const next = curr === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem(THEME_KEY, next);
        syncThemeIcon();
      });

      activeIndex = firstIncompleteIndex();
      syncThemeIcon();
      render();
    })();
  </script>
  <% } %>
</section>

<section class="panel utilities-panel">
  <h2>Yeni Zikir Ekle</h2>
  <form action="/zikirs" method="post" class="stack">
    <label>
      Baslik
      <input type="text" name="title" required />
    </label>
    <label>
      Aciklama
      <textarea name="description" rows="2"></textarea>
    </label>
    <label>
      Hedef Adet
      <input type="number" name="targetCount" min="1" value="33" required />
    </label>
    <button type="submit" class="btn">Zikir Ekle</button>
  </form>
</section>

<section class="panel utilities-panel">
  <h2>Hazir Zikirler</h2>
  <% if (!presets.length) { %>
  <p class="muted">Henuz hazir zikir yok.</p>
  <% } %>
  <ul class="list">
    <% presets.forEach((item) => { %>
    <li>
      <div>
        <strong><%= item.title %></strong>
        <p><%= item.description || 'Aciklama yok.' %></p>
        <small>Hedef: <%= item.target_count %> | Ekleyen: <%= item.creator || 'admin' %></small>
      </div>
      <form action="/presets/<%= item.id %>/add" method="post">
        <button class="btn" type="submit">Panelime Ekle</button>
      </form>
    </li>
    <% }) %>
  </ul>
</section>

<%- include('partials/footer') %>
